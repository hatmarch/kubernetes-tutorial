<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>StatefulSets :: Kubernetes Tutorial</title>
    <link rel="canonical" href="https://hatmarch.github.io/kubernetes-tutorial/kubernetes-tutorial/statefulset.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://hatmarch.github.io/kubernetes-tutorial">Kubernetes Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="kubernetes-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">1. Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#tutorial-all-local">CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#install-minikube">Install Minikube</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#start-kubernetes">Start Kubernetes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">2. Beginner</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kubectl.html">kubectl</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pod-rs-deployment.html">Pod, ReplicaSet, Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service.html">Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="logs.html">Logs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service-magic.html">Service Magic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="blue-green.html">Blue/Green Deployments</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Elementary</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="building-images.html">Building Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources.html">Resources and Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rolling-updates.html">Rolling updates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="live-ready.html">Liveness, Readiness &amp; Startup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configmap.html">ConfigMap</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Intermediate</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="secrets.html">Secrets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crds.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="volumes-persistentvolumes.html">Volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="taints-affinity.html">Taints &amp; Affinity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jobs-cronjobs.html">Jobs &amp; CronJobs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="daemonset.html">DaemonSet</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="statefulset.html">StatefulSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">5. Advanced</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ingress.html">Ingress</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">kubernetes-tutorial</a></li>
    <li>4. Intermediate</li>
    <li><a href="statefulset.html">StatefulSet</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///workspaces/kubernetes-tutorial/documentation/modules/ROOT/pages/statefulset.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">StatefulSets</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A <code>StatefulSet</code> provides a unique identity to the Pods that are managing.
It can be used when your application requires a unique network identifier or persistence storage across Pod (re)scheduling or some guarantee about the ordering of deployment and scaling.</p>
</div>
<div class="paragraph">
<p>One of the most typical examples of using <em>StatefulSets</em> is when you need to deploy a primary/secondary servers (i.e database cluster) where you need to know beforehand the hostname of each of the servers to start the cluster.
Also, when you scale up and down you want to do it in a specified order (i.e you want to start the primary node first and then the secondary node).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>StatefulSet</code> requires a Kubernetes <em>Headless Service</em> instead of a standard Kubernetes <em>service</em>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preparation"><a class="anchor" href="#_preparation"></a>Preparation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_namespace_setup"><a class="anchor" href="#_namespace_setup"></a>Namespace Setup</h3>
<div class="paragraph">
<p>Make sure you are in the correct namespace:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You will need to create the <code>myspace</code> if you haven&#8217;t already.  Check for the existence of the namespace with</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get ns myspace</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the response is:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Error from server (NotFound): namespaces "myspace" not found</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can create the namespace with:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create ns myspace</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div id="stateful-change-context-resource" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl config set-context --current --namespace=myspace</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_watch_terminal"><a class="anchor" href="#_watch_terminal"></a>Watch Terminal</h3>
<div class="paragraph">
<p>To be able to observe what&#8217;s going on, let&#8217;s open another terminal (<strong>Terminal 2</strong>) and <code>watch</code> what happens as we run our different jobs</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_terminal-2">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch -n 1 "kubectl get pods -o wide \<i class="conum" data-value="1"></i><b>(1)</b>
  | awk '{print \$1 \" \" \$2 \" \" \$3 \" \" \$5 \" \" \$7}' | column -t" <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the <code>-o wide</code> option allows us to see the node that the pod is schedule to</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>to keep the line from getting too long we&#8217;ll use <code>awk</code> and <code>column</code> to get and format only the columns we want</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multi_node_minikube"><a class="anchor" href="#_multi_node_minikube"></a>Multi-node (minikube)</h3>
<div class="paragraph">
<p>If your cluster is running multiple nodes and you need the stateful service to be assigned to a specific node so that you can connect to the service externally, replace <code>NODE</code> with the name of the node you don&#8217;t want to run the stateful service on</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NODE=devnation-02 <i class="conum" data-value="1"></i><b>(1)</b>
kubectl taint node ${NODE} app=quarkus-statefulset:NoExecute</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace this and/or repeat for all the nodes in your cluster that you don&#8217;t want the stateful set to be assigned to.  See also <a href="taints-affinity.html" class="page" target="_blank" rel="noopener">Taints and Affinity section</a></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_statefulset"><a class="anchor" href="#_statefulset"></a>StatefulSet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>StatefulSet is created by using the Kubernetes <code>StatefulSet</code> resource with a <strong>"headless service"</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: quarkus-statefulset
  labels:
    app: quarkus-statefulset
spec:
  serviceName: "quarkus" <i class="conum" data-value="1"></i><b>(1)</b>
  replicas: 2
  template:
    metadata:
      labels:
        app: quarkus-statefulset
    spec:
      containers:
      - name: quarkus-statefulset
        image: quay.io/rhdevelopers/quarkus-demo:v1
        ports:
        - containerPort: 8080
          name: web</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sets the <code>statefulset</code> name used as a hostname.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hostname follows the same pattern in all cases <code>serviceName</code> + a number starting from 0 and it is incremented for every replica by one.</p>
</div>
<div class="paragraph">
<p>And a headless service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: quarkus-statefulset
  labels:
    app: quarkus-statefulset
spec:
  ports:
  - port: 8080
    name: web
  clusterIP: None <i class="conum" data-value="1"></i><b>(1)</b>
  selector:
    app: quarkus-statefulset</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes service headless.</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/quarkus-statefulset.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should then see the following in the watch terminal</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_terminal-2">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                     READY   STATUS    RESTARTS   AGE
<mark>quarkus-statefulset-0</mark>   1/1     Running   0          12s</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice that the Pod name is the <code>serviceName</code> with a <code>-0</code>, as it is the first (0th if you will) instance.  This is referred to as its <em>ordinal index</em></p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the stateful set</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get statefulsets</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                  READY   AGE
quarkus-statefulset   1/1     109s</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with <code>deployments</code> we can scale <code>statefulsets</code></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl scale sts \<i class="conum" data-value="1"></i><b>(1)</b>
  quarkus-statefulset --replicas=3</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>sts</code> is the shortname of the <code>statefulset</code> api-resource</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then in the watch terminal see</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_terminal-2">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                    READY   STATUS    RESTARTS   AGE
quarkus-statefulset-0   1/1     Running   0          95s
<mark>quarkus-statefulset-1</mark>   1/1     Running   0          2s
<mark>quarkus-statefulset-2</mark>   1/1     Running   0          1s</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice that the name of the Pods continues to use the same nomenclature of <code>serviceName</code> + <code>-</code> + ordinal index</p>
</div>
<div class="paragraph">
<p>Also, if you check the order of events in the Kubernetes cluster, you&#8217;ll notice that the Pod name ending with <code>-1</code> is created <strong>before</strong> those with higher ordinal index (e.g. with suffix of <code>-2</code>).</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get events --sort-by=.metadata.creationTimestamp</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">4m4s        Normal   SuccessfulCreate          statefulset/quarkus-statefulset   create Pod quarkus-statefulset-1 in StatefulSet quarkus-statefulset successful
4m3s        Normal   Pulled                    pod/quarkus-statefulset-1         Container image "quay.io/rhdevelopers/quarkus-demo:v1" already present on machine
4m3s        Normal   Scheduled                 pod/quarkus-statefulset-2         Successfully assigned default/quarkus-statefulset-2 to kube
4m3s        Normal   Created                   pod/quarkus-statefulset-1         Created container quarkus-statefulset
4m3s        Normal   Started                   pod/quarkus-statefulset-1         Started container quarkus-statefulset
4m3s        Normal   SuccessfulCreate          statefulset/quarkus-statefulset   create Pod quarkus-statefulset-2 in StatefulSet quarkus-statefulset successful
4m2s        Normal   Pulled                    pod/quarkus-statefulset-2         Container image "quay.io/rhdevelopers/quarkus-demo:v1" already present on machine
4m2s        Normal   Created                   pod/quarkus-statefulset-2         Created container quarkus-statefulset
4m2s        Normal   Started                   pod/quarkus-statefulset-2         Started container quarkus-statefulset</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exposing_statefulsets"><a class="anchor" href="#_exposing_statefulsets"></a>Exposing StatefulSets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Given that our stateful set needed to use a headless service, you&#8217;ll notice that no external IP is assigned that we can use to access our pods</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe svc quarkus-statefulset</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:              quarkus-statefulset
Namespace:         myspace
Labels:            app=quarkus-statefulset
Annotations:       &lt;none&gt;
Selector:          app=quarkus-statefulset
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
#IP:                None#
#IPs:               None#
Port:              web  8080/TCP
TargetPort:        8080/TCP
Endpoints:         172.17.0.3:8080,172.17.0.4:8080,172.17.0.5:8080
Session Affinity:  None
Events:            &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead, only (internal) endpoints are assigned</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">describe endpoints quarkus-statefulset</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:         quarkus-statefulset
Namespace:    myspace
Labels:       app=quarkus-statefulset
              service.kubernetes.io/headless=
Annotations:  endpoints.kubernetes.io/last-change-trigger-time: 2021-07-20T04:45:21Z
Subsets:
  Addresses:          172.17.0.3,172.17.0.4,172.17.0.5
  NotReadyAddresses:  &lt;none&gt;
  Ports:
    Name  Port  Protocol
    ----  ----  --------
    web   8080  TCP

Events:  &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This kind of makes sense since the whole point is that we want the name of each pod to have a predictable name.  To assist with our ability to access pods by name, kubernetes exposes a label on all statefulset pods that we can use as a selector to our service</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe pod quarkus-statefulset-2</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the abbreviated output shows our label (highlighted)</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:         quarkus-statefulset-2
Namespace:    myspace
Priority:     0
Node:         devnation/192.168.49.2
Start Time:   Tue, 20 Jul 2021 04:45:04 +0000
Labels:       app=quarkus-statefulset
              controller-revision-hash=quarkus-statefulset-6bf5d59699
              <mark>statefulset.kubernetes.io/pod-name=quarkus-statefulset-2</mark>
Annotations:  &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use this label as a selector for a service that targets this specific pod.  Use <span class="keyseq"><kbd>CMD</kbd>+<kbd>p</kbd></span> to open <code>quarkus-statefulset-external-svc.yaml</code> quickly:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: v1
kind: Service
metadata:
  name: quarkus-statefulset-2
spec:
  type: LoadBalancer <i class="conum" data-value="1"></i><b>(1)</b>
  externalTrafficPolicy: Local <i class="conum" data-value="2"></i><b>(2)</b>
  selector:
    statefulset.kubernetes.io/pod-name: quarkus-statefulset-2 <i class="conum" data-value="3"></i><b>(3)</b>
  ports:
  - port: 8080
    name: web</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Indicate that this service should be exposed via LoadBalancer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Prevent excessive hops by routing traffic directly to the node</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A selector that leverages the label provided automatically by the Kubernetes StatefulSet functionality</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Having reviewed the service we can now create it:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/quarkus-statefulset-external-svc.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Meanwhile, in the main terminal, send a request:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset4_remote-minikube"></a>Remote Minikube</p>
</li>
<li>
<p><a id="tabset4_hosted"></a>Hosted</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP=$(minikube ip -p devnation)
PORT=$(kubectl get service/quarkus-statefulset-2 -o jsonpath="{.spec.ports[*].nodePort}")</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_remote-minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP=$(kubectl cluster-info | grep "Kubernetes " | sed -r 's/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g' | sed -r 's#^.*https://([^:]+):[[:digit:]]+$#\1#')
PORT=$(kubectl get service/quarkus-statefulset-2 -o jsonpath="{.spec.ports[*].nodePort}")</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_hosted">
<div class="paragraph">
<p>If using a hosted Kubernetes cluster like OpenShift then use curl and the EXTERNAL-IP address with port <code>8080</code> or get it using <code>kubectl</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP=$(kubectl get service quarkus-statefulset-2 -o jsonpath="{.status.loadBalancer.ingress[0].ip}")
PORT=$(kubectl get service quarkus-statefulset-2 -o jsonpath="{.spec.ports[*].port}")</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you are in AWS, you need to get the <code>hostname</code> instead of <code>ip.</code>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP=$(kubectl get service quarkus-statefulset-2 -o jsonpath="{.status.loadBalancer.ingress[0].hostname}")</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Curl the Service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl $IP:$PORT</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should receive the following back</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Supersonic Subatomic Java with Quarkus quarkus-statefulset-2:1 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice the hostname of <code>quarkus-statefulset-2</code>.  This is part of why we used stateful sets in the first place</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scale_down_and_cleanup"><a class="anchor" href="#_scale_down_and_cleanup"></a>Scale Down and Cleanup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, if we scale down to two instances, the one that is destroyed is not randomly chosen, but the one started later (<code>quarkus-statefulset-2</code>).</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl scale sts quarkus-statefulset --replicas=2</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_terminal-2"></a>Terminal 2</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_terminal-2">
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                    READY   STATUS        RESTARTS   AGE
quarkus-statefulset-0   1/1     Running       0          9m22s
quarkus-statefulset-1   1/1     Running       0          7m49s
<mark>quarkus-statefulset-2   0/1     Terminating   0          7m48s</mark></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Beware when using stateful sets and services that this could break things.  Remember that the service we created above referenced that exact pod in the stateful set.  If you try to reach it now</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl ${IP}:${PORT}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll get an error (perhaps like this one)</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl: (7) Failed to connect to 192.168.86.58 port 31834: Connection refused</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean Up</h3>
<div class="paragraph">
<p>You&#8217;ve now reached the end of this section.  You can clean up all aspects of the statefulset by deleting the yaml that spawned it (as well as the external service)</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f apps/kubefiles/quarkus-statefulset.yaml
kubectl delete -f apps/kubefiles/quarkus-statefulset-external-svc.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
